<?php

include_once('oa_portal.theme.inc');

/**
 * Implements hook_init().
 */
function oa_portal_init() {
  if (arg(0) == 'portal') {
    $path = drupal_get_path('module', 'oa_portal');
    drupal_add_css($path . '/css/forms.css');
    drupal_add_css($path . '/css/phases.css');
    drupal_add_js($path . '/js/jquery.ba-untils.min.js');
    drupal_add_js($path . '/js/main.js');
  }
}

/**
 * Implements hook_menu().
 */
function oa_portal_menu() {
  $items = array();

  $items['admin/portal'] = array(
    'title' => 'OA Portal Admin', 
    'page callback' => 'oa_portal_admin', 
    'access arguments' => array('administer site configuration'),
    'file' => 'oa_portal.admin.inc'
  );
  $items['messages'] = array(
    'title' => 'My Message Center', 
    'page callback' => 'drupal_get_form',
    'page arguments' => array('oa_portal_messages_page'),
    'access arguments' => array('access portal'),
    'file' => 'oa_portal.pages.inc'
  );
  $items['messages/%'] = array(
    'title' => 'My Message Center', 
    'page callback' => 'oa_portal_message_page',
    'page arguments' => array(1),
    'access arguments' => array('access portal'),
    'file' => 'oa_portal.pages.inc'
  );
  $items['portal'] = array(
    'title' => 'My OA Healthcare Documents', 
    'page callback' => 'oa_portal_page', 
    'access arguments' => array('access portal'),
    'file' => 'oa_portal.pages.inc'
  );
  $items['update-password'] = array(
    'title' => 'Update Password', 
    'page callback' => 'drupal_get_form',
    'page arguments' => array('oa_portal_change_password_form'),
    'access arguments' => array('access portal'),
    'file' => 'oa_portal.forms.inc',
    'type' => MENU_SUGGESTED_ITEM,
  );
  $items['portal/file/%'] = array(
    'title' => 'OA Portal Download File', 
    'page callback' => 'oa_portal_download_file',
    'page arguments' => array(2),
    'access arguments' => array('administer site configuration'),
    'file' => 'oa_portal.pages.inc'
  );
  $items['portal/createcoversheet/%'] = array(
    'title' => 'OA Portal Download File', 
    'page callback' => 'oa_portal_ucm_createcoversheet',
    'page arguments' => array(2),
    'access arguments' => array('administer site configuration'),
    'file' => 'oa_portal.pages.inc'
  );

  $items['portal/autosave'] = array(
    'title' => 'OA Portal Autosave', 
    'page callback' => 'oa_portal_autosave',
    'access arguments' => array('access portal'),
    'file' => 'oa_portal.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $p = oa_portal_forms_info();
  foreach ($p AS $pk => $phase) {
    foreach (element_children($phase) AS $sk) {
      $section = $phase[$sk];
      $items['portal/'. $pk .'/'. $sk] = array(
        'type' => MENU_CALLBACK,
        'title' => $section['#title'],
        'page callback' => 'drupal_get_form',
        'page arguments' => array('oa_portal_'. $pk .'_'. $sk .'_form'),
        'access callback' => 'oa_portal_candidate_access',
        'access arguments' => array($pk, $sk),
        'file' => 'oa_portal.forms.inc',
      );
    }
  }
  return $items;
}

/**
 * Access callback for menu items
 */
function oa_portal_candidate_access($phase, $section) {
  global $user;
  $account = user_load($user->uid);
  if (user_access('administer portal', $account)) {
    return TRUE;
  }

  // Per-Candidate access checking
  $compliance = oa_portal_forms_info_candidate($account->rmaxid);

  if ($section = 'p1' || ($section == 'p2' && $compliance['p1']['approved_date']) || ($section == 'p3' && $compliance['p2']['approved_date'])) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Status for Portal section items
 */
function oa_portal_candidate_status($compliance, $phase, $section) {
  global $user;
  $p = oa_portal_forms_info();
  
  // If section is marked as read-only, verify phase is open
  if ($p[$phase][$section]['#status'] == 'read-only') {
    if (($section == 'p2' && $compliance['p1']['approved_date']) || ($section == 'p3' && $compliance['p2']['approved_date'])) {
      return 'open';
    }
    return 'closed';
  }

  // Global access checking - If phase or section is closed
  if ($p[$phase]['#status'] == 'closed' || $p[$phase][$section]['#status'] == 'closed') {
    return 'closed';
  }

  // Check if dependencies are not met
  if (count(array_intersect($p[$phase][$section]['#dependencies'], $compliance['missing_all']))) {
    dsm('Cant open '. $phase .' - '. $section .' due to missing dependencies');
    return 'closed';
  }

  if (count(array_intersect($p[$phase][$section]['#formtypes'], $compliance['open']))) {
    dsm($phase .' - '. $section .' is open');
    return 'open';
  }
  if (count(array_intersect($p[$phase][$section]['#formtypes'], $compliance['under-review']))) {
    dsm($phase .' - '. $section .' is under review');
    return 'under-review';
  }
  if (count(array_intersect($p[$phase][$section]['#formtypes'], $compliance['closed']))) {
    dsm($phase .' - '. $section .' is closed');
    return 'closed';
  }
  
  dsm('Something unexpected happened.');
  return NULL;
}

/**
 * Implements hook_block().
 */
function oa_portal_block($op = 'list', $delta = 0, $edit = array()) {
  switch ($op) {
    case 'list':
      $blocks['oap_messages'] = array('info' => t('OA Portal: Messages'), 'cache' => BLOCK_CACHE_PER_USER);
      $blocks['oap_phase_status'] = array('info' => t('OA Portal: Phase status'), 'cache' => BLOCK_CACHE_PER_USER);
      return $blocks;
    break;
    case 'view':
      return array('content' => oa_portal_block_view($delta));
    break;
  }
}

/**
 * Invokes the theme associated with a block.
 *
 * @param string $delta
 *    The key identifier for a block.
 */
function oa_portal_block_view($delta) {
  global $user;
  include_once('oa_portal.blocks.inc');
  switch ($delta) {
    case 'oap_messages':
    case 'oap_phase_status':
      return theme($delta);
    break;
  }
}

/**
 ** Implementation of hook_theme();
 */
function oa_portal_theme($existing, $type, $theme, $path) {
  $path = drupal_get_path('module', 'oa_portal');
  return array(
    'oap_phase' => array(
      'template' => 'oap_phase',
      'path' => $path . '/templates',
      'arguments' => array('id' => NULL, 'title' => NULL, 'status' => NULL, 'phases' => NULL, 'completed' => NULL),
    ),
    'oap_phase_row' => array(
      'template' => 'oap_phase_row',
      'path' => $path . '/templates',
      'arguments' => array('link' => NULL, 'status' => NULL),
    ),
    'oap_messages' => array(
      'template' => 'oap_messages',
      'path' => $path . '/templates',
      'arguments' => array('messages' => NULL, 'tip' => NULL, 'count' => NULL),
    ),
    'oap_message_row' => array(
      'template' => 'oap_message_row',
      'path' => $path . '/templates',
      'arguments' => array('date' => NULL, 'subject' => NULL, 'body' => NULL, 'link' => NULL),
    ),
    'oap_message_page' => array(
      'arguments' => array('date' => NULL, 'subject' => NULL, 'body' => NULL),
    ),
    'oap_messages_page' => array(
      'template' => 'oap_messages_page',
      'path' => $path . '/templates',
      'arguments' => array('form' => NULL),
    ),
    'oap_phase_status' => array(
      'template' => 'oap_phase_status',
      'path' => $path . '/templates',
    ),
    'oap_tooltip' => array(
      'template' => 'oap_tooltip',
      'path' => $path . '/templates',
      'arguments' => array('status' => NULL, 'string' => NULL),
    ),
    'oap_doc_download' => array(
      'template' => 'oap_doc_download',
      'path' => $path . '/templates',
      'arguments' => array('docs' => NULL),
    ),
  );
}

/**
 * 
 */
function oa_portal_forms_info() {
  $p = array();
  
  $p['p1'] = array(
    '#title' => t('Phase 1'),
    '#status' => 'open',
    'contact' => array(
      '#title' => t('Contact Information'),
      '#status' => 'closed',
    ),
    'application' => array(
      '#title' => t('Application'),
      '#formtypes' => array(2),
    ),
    'checklist' => array(
      '#title' => t('Skills Checklist'),
      // Set by candidate req
      '#formtypes' => NULL,
    ),
  );
  
  // Licensure formtypes:
  
  $licensure_formtypes = array();
  
  $p['p2'] = array(
    '#title' => t('Phase 2'),
    'professional_orgs' => array(
      '#title' => t('Professional Organizations'),
      '#dependencies' => array(2),
      '#status' => 'read-only',
      '#formtypes' => array(),
    ),
    'licensure_certs' => array(
      '#title' => t('Licensure Certifications'),
      // Set by candidate req
      '#formtypes' => NULL,
    ),
    'background_reference' => array(
      '#title' => t('Background/Reference Check'),
      '#dependencies' => array(),
      '#formtypes' => array(233, 476, 477),
    ),
    'capabilities' => array(
      '#title' => t('Capabilities Questionnaire'),
      '#dependencies' => array(),
      '#formtypes' => array(5),
    ),
    'policies' => array(
      '#title' => t('Policies & Agreements'),
      '#dependencies' => array(),
      '#formtypes' => array(256, 433, 432),
    ),
    'medical' => array(
      '#title' => t('Medical Authorization and Disclosures'),
      '#dependencies' => array(),
      // Missing others.
      '#formtypes' => array(263),
    ),
    'competency' => array(
      '#title' => t('Competency Test'),
      '#status' => 'read-only',
    ),
  );
  $p['p3'] = array(
    '#title' => t('Phase 3'),
    '#status' => 'locked',
    'paycheck' => array(
      '#title' => t('Paycheck Method'),
      '#phase' => 3,
      '#dependencies' => array(),
      '#status' => '',
      '#formtypes' => array(),
    ),
    'w4' => array(
      '#title' => t('W4'),
      '#phase' => 3,
      '#dependencies' => array(),
      '#status' => '',
      '#formtypes' => array(),
    ),
    'i9' => array(
      '#title' => t('I-9'),
      '#dependencies' => array(),
      '#status' => '',
      '#formtypes' => array(),
    ),
    'eeo' => array(
      '#title' => t('EEO Form'),
      '#dependencies' => array(),
      '#status' => '',
      '#formtypes' => array(),
    ),
    'work_policy' => array(
      '#title' => t('Work Policy'),
      '#dependencies' => array(),
      '#status' => '',
      '#formtypes' => array(),
    ),
  );
  return $p;
}

function oa_portal_forms_info_candidate($rmaxid, $complianceid) {
  $p = oa_portal_forms_info();

  $compliance = oa_portal_get_modality_formtypes($rmaxid, $complianceid);
  $missing_checklists = array_intersect(range(480, 532) + array(547), $compliance[1]['missing']);
  $pr_checklists = array_intersect(range(480, 532) + array(547), $compliance['under-review']);
  $p['p1']['checklists']['#formtypes'] = $missing_checklists;
  
  // @TODO Need to filter by file category?
  $missing_checklists = array(); //array_intersect(range(480, 532) + array(547), $compliance[2]['missing']);
  $p['p2']['licensure_certs'] = $missing_licensures;

  return $p;
}

/**
 * SOAP interface
 */
function oa_portal_soap($method, $params, $debug = FALSE) {
  ini_set("soap.wsdl_cache_enabled", "0");
  $wsdl = array(
    'createcoversheet' => 'OAServices.wsdl',
    'createpdfform' => 'OAServices.wsdl',
    'drupalcounts' => 'OAServices.wsdl',
    'oacheckin' => 'OAServices.wsdl',
    'profileview' => 'OAServices.wsdl',
    'CheckInUniversal' => 'CheckIn.wsdl',
    'DocInfoByName' => 'DocInfo.wsdl',
    'GetFileByID' => 'GetFile.wsdl',
    'GetFileByName' => 'GetFile.wsdl',
    'ComplianceCheck' => 'OAServices.wsdl',
    'AdvancedSearch' => 'Search.wsdl',
  );
  ini_set('display_errors', 1);
  $wsdl = dirname(__FILE__) .'/wsdl/'. $wsdl[$method];

  $soap_params = array(
    'login' => 'weblogic',
    'password' => '0ATraining',
    'trace' => 1,
//    'exceptions' => 0
  );

  try {
    ini_set('default_socket_timeout', 5);
    $client = @new SoapClient($wsdl, $soap_params);
    $response = $client->{$method}($params);
  }
  catch(SoapFault $e){
    // handle issues returned by the web service
    oa_portal_503($e);
  }
  catch(Exception $e){
    // handle PHP issues with the request
    oa_portal_500($e);
  }

  if ($debug) {
    dsm($params, $method . ' $params');
    dsm($client, $method . ' $client');
    dsm($response, $method . ' $response');
  }

  return $response;
}

/**
 * Test ping server
 */
function oa_portal_soap_ping_server() {
  $results = oa_portal_soap('pingServer', array());
  dsm($results, 'SOAP $results');
}

function oa_portal_soap_file_form($form_state) {
  $form['#attributes'] = array('enctype' => "multipart/form-data");
  $form['upload'] = array(
    '#type' => 'file', 
    '#title' => t('Post a file to UCM'),
    '#size' => 40,
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Upload',
  );
  return $form;
}

function oa_portal_soap_file_form_submit($form, &$form_state) {
  if (isset($_FILES['files']) && is_uploaded_file($_FILES['files']['tmp_name']['upload'])) {
    $filepath = $_FILES['files']['tmp_name']['upload'];
    $filesize = $_FILES['files']['size']['upload'];
    $filename = $_FILES['files']['name']['upload'];
    $handle = fopen($filepath, "r");
    $contents = fread($handle, $filesize);
    fclose($handle);

    $params = array(
      'dDocType' => 'Rmax',
      'dDocAuthor' => 'weblogic',
      'dDocAccount' => 'Recruit/QA',
      'dSecurityGroup' => 'Form',
      'dDocTitle' => 'Test from RP',
      'dDocName' => 'RP' . time(),
      'primaryFile' =>array(
        'fileName'=> $_FILES['files']['name']['upload'],
        'fileContent' => $contents),
    );

    $results = oa_portal_soap('CheckInUniversal', $params);
    dsm($results, 'SOAP $results for file upload');
  }
}

/**
 * Implementation of hook_fapi_validation_rules
 */
function oa_portal_fapi_validation_rules() {
  return array(
    'not_none' => array(
      'callback' => 'oa_portal_rule_not_none',
      'error_msg' => 'You must select a value for %field'
    ),
  );
}

/**
 * Rule callback for not_none
 */
function oa_portal_rule_not_none($value) {
  return !((string) $value == 'none');
}

function oa_portal_get_modality_formtypes($rmaxid, $modality) {
  $params = array(
    'rmaxid' => $rmaxid,
    'complianceRecordID' => $modality,
    'doNotUpdate' => 1,
  );
  $results = oa_portal_soap('drupalcounts', $params, TRUE);
  foreach (array(1, 2, 3) AS $k) {
    $return[$k]['approved_date'] = $results->drupalcountsResult->{'phase'. $k .'ApprovedDate'};
    $return[$k]['missing'] = explode(',', $results->drupalcountsResult->{'OAPhase'. $k .'MissingFormIDs'});
  }
  $return['open'] = array_merge(
    ($results->ComplianceCheckResult->expired == 0) ? array() : explode(',', $results->ComplianceCheckResult->expired),
    ($results->ComplianceCheckResult->missing == 0) ? array() : explode(',', $results->ComplianceCheckResult->missing),
    ($results->ComplianceCheckResult->rejected == 0) ? array() : explode(',', $results->ComplianceCheckResult->rejected)
  );
  $return['under-review'] = array_merge(
    ($results->ComplianceCheckResult->inprogress == 0) ? array() : explode(',', $results->ComplianceCheckResult->inprogress),
    ($results->ComplianceCheckResult->pendingreview == 0) ? array() : explode(',', $results->ComplianceCheckResult->pendingreview)
  );
  $return['closed'] = ($results->ComplianceCheckResult->approved == 0) ? array() : explode(',', $results->ComplianceCheckResult->approved);
  $return['complianceApprovedDate'] = $results->drupalcountsResult->complianceApprovedDate;
  $return['drupalcountsResult'] = $results->drupalcountsResult;
dsm($return, 'oa_portal_get_modality_formtypes return');
  return $return;
}

/**
 * Implements hook_ajax_validate_pass().
 */
function oa_portal_ajax_validate_pass(&$form, &$form_state, &$data, &$pass) {
/*
  if ($form['form_id']['#value'] == 'oa_portal_p1_checklist_form') {
dsm($data, '$data in validate_pass');
    dsm($form, 'oa_portal_ajax_validate_pass $form');
  }
  return TRUE;
*/
}

function oa_portal_ucm_oacheckin($formtype, $fields) {
  global $user;
  $account = user_load($user->uid);
  $rmaxid = $account->rmaxid;
  $params = array(
    'dDocName' => $rmaxid ."_". $formtype,
    // @TODO When is this Form vs FormSecure?
    'dSecurityGroup' => 'Form',
    'dDocAuthor' => 'weblogic',
    'dDocAccount' => 'Recruit/QA',
    'dDocType' => 'Rmax',
    'dDocTitle' => $formtype ."-". $rmaxid,
    'xContentType' => "Form",
    'xFormType' => $formtype,
    'xRM_ID' => $rmaxid,
    'xStatus' => 'Pending Review',
    'xComments' => '',
    'xRejectReason' => '',
    'xRejectOther' => '',
    'xSuccessAudit' => '',
    'fields' => $fields,
  );
  return TRUE;
  
  $result = oa_portal_soap('oacheckin', $params, TRUE);
  return ($result->oacheckinResult == 'something') ? TRUE : $result->oacheckinResult;
}

/**
 * Get file contents by dID
 */
function oa_portal_ucm_getfilebyname($dDocName) {
  $result = oa_portal_soap('GetFileByName', array('dDocName' => $dDocName, 'revisionSelectionMethod' => 'Latest'), TRUE);
  return $result->GetFileByNameResult;
}

/**
 * Get file contents by formtype (dDocName)
 */
function oa_portal_ucm_rmax_getfilebyname($rmaxid, $formtype) {
  $result = oa_portal_soap('GetFileByName', array('dDocName' => $rmaxid .'_'. $formtype), TRUE);
  return $result->GetFileByNameResult;
}

/**
 * Get file info by dID
 */
function oa_portal_ucm_docinfobyid($dID) {
  $result = oa_portal_soap('DocInfoByID', array('dID' => $dID), TRUE);
  return (get_class($result) == 'SoapFault') ? FALSE : $result->DocInfoByIDResult;;
}

/**
 * Get file info by formtype (dDocName)
 */
function oa_portal_ucm_docinfobyame($rmaxid, $formtype) {
  $result = oa_portal_soap('DocInfoByName', array('dDocName' => $rmaxid .'_'. $formtype));
  return (get_class($result) == 'SoapFault') ? FALSE : $result->DocInfoByNameResult;
}

/**
 * Get RMax profile by RMaxID
 */
function oa_portal_ucm_profileview($rmaxid) {
  $result = oa_portal_soap('profileview', array('schViewName' => 'vOA_Profile', 'whereClause' => "rmaxid='". $rmaxid ."'"), TRUE);
  if (get_class($result) == 'SoapFault') {
dsm('Found a SoapFault where we shouldnt have one');
    return FALSE;
  }
  $profile = $result->profileviewResult->profiledata;
  $profile->name = $profile->fname .' '. $profile->lname;
  $address = $profile->addressline1;
  $address .= ($profile->addressline2) ? ' '. $profile->addressline2 : NULL;
  $address .= ($profile->addressline3) ? ' '. $profile->addressline3 : NULL;
  $address .= ' '. $profile->city .', '. $profile->state .' '. $profile->postal;
  $profile->address = $address;
  return $profile;
}


function oa_portal_ucm_createpdfform($rmaxid, $formtype, $fields) {
  $params = array(
    'rmaxid' => $rmaxid,
    'formid' => $formtype,
    'extraProps' => array(),
  );
  foreach ($fields AS $k => $v) {
    $params['extraProps']['property'][] = array(
      'name' => $k,
      'value' => $v,
    );
  }
  //$result = oa_portal_soap('createpdfform', $params, TRUE);
  $result = oa_portal_soap('createpdfform', $params);
  return (get_class($result) == 'SoapFault') ? FALSE : $result->createpdfformResult;
}

function oa_portal_html_to_pdf_string($rmaxid, $formtype, $values, $form) {
  $to_render = oa_portal_html_to_pdf_change_type($forms, $values);
  return drupal_render($to_render);
}

function oa_portal_html_to_pdf_change_type($felements, $values) {
  foreach ($felements AS $ek => $element) {
    if ($children = element_children($elements)) {
      $child_values = $values[$ek];
      $children = oa_portal_html_to_pdf_change_type($children, $child_values);
    }
    elseif ($felements[$ek]['#type']) {
      $felements[$ek]['#type'] = 'pdf_'. $felement['#type'];
      $felements[$ek]['#value'] = $values[$ek];
    }
  }
  return $felements;
}


/**
 * Get file info by formtype (dDocName)
 */
function oa_portal_ucm_advanced_search_docs_not_missing($rmaxid, $formtypes) {
  $formtypesquery = 'xFormType <matches> `'. implode($formtypes, '` <or> xFormType <matches> `') .'`';
  $query = 'xRM_ID <matches> `'. $rmaxid .'` <AND> <not>xStatus <matches> `Missing` <AND>('. $formtypesquery .')';
  $result = oa_portal_soap('AdvancedSearch', array('queryText' => $query, 'sortField' => 'dDocTitle', 'sortOrder' => 'Asc', 'resultCount' => '20'));
  if (get_class($result) == 'SoapFault') {
    return FALSE;
  }
  return (is_array($result->AdvancedSearchResult->SearchResults)) ? $result->AdvancedSearchResult->SearchResults : array($result->AdvancedSearchResult->SearchResults);
}

function oa_portal_500($e) {
  drupal_set_header($_SERVER['SERVER_PROTOCOL'] . ' 500 Internal Server Error');

  watchdog('500 internal server error', check_plain($_GET['q']) .' <pre>'. print_r($e, TRUE) .'</pre>', NULL, WATCHDOG_WARNING);

  // Keep old path for reference, and to allow forms to redirect to it.
  if (!isset($_REQUEST['destination'])) {
    $_REQUEST['destination'] = $_GET['q'];
  }

  $path = drupal_get_normal_path(variable_get('site_500', ''));
  if ($path && $path != $_GET['q']) {
    // Set the active item in case there are tabs to display, or other
    // dependencies on the path.
    menu_set_active_item($path);
    $return = menu_execute_active_handler($path);
  }

  if (empty($return) || $return == MENU_NOT_FOUND || $return == MENU_ACCESS_DENIED) {
    drupal_set_title(t('Internal Server Error'));
    $return = t('The requested page could not be delivered. Please try again later.');
    $return .= '<div class="error-message">'. $e->getMessage() .'</div>';
  }

  // To conserve CPU and bandwidth, omit the blocks.
  print theme('page', $return, FALSE);
  exit();
}

function oa_portal_503($e) {
  drupal_set_header($_SERVER['SERVER_PROTOCOL'] . ' 503 Service Unavailable');

  watchdog('503 service unavailable', check_plain($_GET['q']) .' <pre>'. print_r($e, TRUE) .'</pre>', NULL, WATCHDOG_WARNING);

  // Keep old path for reference, and to allow forms to redirect to it.
  if (!isset($_REQUEST['destination'])) {
    $_REQUEST['destination'] = $_GET['q'];
  }

  $path = drupal_get_normal_path(variable_get('site_503', ''));
  if ($path && $path != $_GET['q']) {
    // Set the active item in case there are tabs to display, or other
    // dependencies on the path.
    menu_set_active_item($path);
    $return = menu_execute_active_handler($path);
  }

  if (empty($return) || $return == MENU_NOT_FOUND || $return == MENU_ACCESS_DENIED) {
    drupal_set_title(t('Service Unavailable'));
    $return = t('The requested page could not be delivered. Please try again later.');
    $return .= '<div class="error-message">'. $e->getMessage() .'</div>';
  }

  // To conserve CPU and bandwidth, omit the blocks.
  print theme('page', $return, FALSE);
  exit();
}


/**
 * Get the autosaved form at a particular path for a user.
 *
 * @param string $form_id
 *   The form_id of the form.
 * @param string $path
 *   The the internal Drupal path where the form is located
 * @param string $uid
 *   Drupal UID of the user
 * @return
 *   An array containing the serialized values of the autosaved form and the timestamp of when the form was autosaved.
 */
function oa_portal_get_autosaved_form($form_id, $path, $uid) {
  $result = db_query("SELECT form_id, serialized, timestamp FROM {autosaved_forms} WHERE form_id = '%s' AND path = '%s' AND uid = %d", $form_id, $path, $uid);
  while ($data = db_fetch_object($result)) {
    $form['serialized'] = $data->serialized;
    $form['timestamp'] = $data->timestamp;
  }
  return $form;
}

/**
 * Figure out what particular case to delete autosaved forms
 *
 * Delete autosave table entry on successful submit
 *
 */
/*
function oa_portal_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  if ($op == 'presave') {
      // we remove ALL edits for that page (not just the users) to avoid:
      //  - user1 asaves but doesnt submit
      //  - user2 edits same node and submits
      //  - user1 comes back to edit -> user1 SHOULD lose edits since user2 has precedence
      db_query("DELETE FROM {autosaved_forms} WHERE form_id = '%s' AND path = '%s'", $node->form_id, $_GET['q']);
  }
}
*/

/**
 * Get the unread messages for a user.
 *
 * @param integer $rmaxid
 *   The RMax ID of the user.
 * @param integer/string $read
 *   The read/unread status of the message (Unread = 0, Has been read = 1, All = 'all')
 * @param integer $limit
 *   The Limit for the query
 * @return
 *   An array containing the individual read/unread messages
 */
function oa_portal_get_messages($rmaxid, $read = 0, $limit = 100) {
  if ($read == 'all') {
    $result = db_query("SELECT * FROM {ucm_messages} WHERE rmaxid = %d ORDER BY timestamp DESC LIMIT $limit", $rmaxid, $limit);
  }
  else {
    $result = db_query("SELECT * FROM {ucm_messages} WHERE rmaxid = %d AND was_read = %d ORDER BY timestamp DESC LIMIT $limit", $rmaxid, $read, $limit);
  }
  $messages = array();
  while ($data = db_fetch_object($result)) {
    $messages[] = $data;
  }
  return (count($messages)) ? $messages : NULL;
}

/**
 * Get a specific message for a user.
 *
 * @param integer $rmaxid
 *   The RMax ID of the user.
 * @param integer $msg_id
 *   The Message ID
 * @return
 *   An object containing the individual message
 */
function oa_portal_get_message($rmaxid, $msg_id) {
  $result = db_query("SELECT * FROM {ucm_messages} WHERE rmaxid = %d AND msg_id = %d LIMIT 1", $rmaxid, $msg_id);
  while ($message = db_fetch_object($result)) {
    return $message;
  }
  return NULL;
}

/**
 * Mark a specific message as read for a user.
 *
 * @param integer $rmaxid
 *   The RMax ID of the user.
 * @param integer $msg_id
 *   The Message ID
 * @return
 *   An object containing the individual message
 */
function oa_portal_mark_message_read($msg_id) {
  global $user;
  $account = user_load($user->uid);
  db_query("UPDATE {ucm_messages} SET was_read = 1 WHERE rmaxid = %d AND msg_id = %d LIMIT 1", $account->rmaxid, $msg_id);

  // @TODO
  if ($this_was_ajax) {
    drupal_json('200');
    exit();
  }
}
