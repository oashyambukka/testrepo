<?php

/**
 * Implements hook_menu().
 */
function oa_onboard_menu() {
  $items = array();
  $items['apply'] = array(
    'page callback' => 'drupal_get_form',
    'page arguments' => array('oa_onboard_form'),
    'access arguments' => array('OA - Review files'),
    'title' => 'Application Form',
  );
  $items['apply/dupecheck'] = array(
    'title' => 'Duplicate Email check',
    'page callback' => 'oa_onboard_dupecheck',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Form callback for onboarding form
 */
function oa_onboard_form($form_state) {
  $form = array();
  $form['#attributes'] = array('enctype' => "multipart/form-data");

  if ($_GET['id']) {
    $form['id'] = array(
      '#type' => 'hidden',
      '#value' => $_GET['id'],
    );
    $form['applying-for'] = array(
      '#type' => 'markup',
      '#value' => t('Applying for Job ID ' . $_GET['id']),
    );
  }
  $form['Candidates'] = array(
    '#tree' => TRUE,
  );
  // Email Address: <fill-in>
  $form['Candidates']['Email'] = array(
    '#type' => 'textfield',
    '#title' => 'Email',
    '#required' => TRUE,
  );
  $form['Candidates']['Email_confirm'] = array(
    '#type' => 'textfield',
    '#title' => 'Email Confirmation',
    '#required' => TRUE,
  );
  
  $form['Candidates']['FirstName'] = array(
    '#type' => 'textfield',
    '#title' => 'First Name',
    '#required' => TRUE,
  );
  $form['Candidates']['LastName'] = array(
    '#type' => 'textfield',
    '#title' => 'Last Name',
    '#required' => TRUE,
  );
  
  $form['Candidates']['PostalAddress'] = array(
    '#tree' => TRUE,
  );
  $form['Candidates']['PostalAddress']['AddressLine1'] = array(
    '#type' => 'textfield',
    '#title' => 'Address',
    '#required' => TRUE,
  );
  $form['Candidates']['PostalAddress']['AddressLine2'] = array(
    '#type' => 'textfield',
    '#title' => 'Address',
  );
  $form['Candidates']['PostalAddress']['Municipality'] = array(
    '#type' => 'textfield',
    '#title' => 'City',
    '#required' => TRUE,
  );
  $form['Candidates']['PostalAddress']['RegionID'] = array( // (from Region table)
    '#type' => 'textfield',
    '#title' => 'State/Province',
    '#required' => TRUE,
  );
  $form['Candidates']['PostalAddress']['PostalCode'] = array(
    '#type' => 'textfield',
    '#title' => 'Zip/Postal Code',
    '#required' => TRUE,
  );
  


  // Primary Phone Number: <fill-in>
  // Secondary Phone Number (optional): <fill-in>
  $form['CandidatePhones'] = array(
    '#tree' => TRUE,
  );
  $form['CandidatePhones'][2] = array(
    '#type' => 'textfield',
    '#title' => 'Primary Phone',
    '#required' => TRUE,
  );
  $form['CandidatePhones'][1] = array(
    '#type' => 'textfield',
    '#title' => 'Cell Phone',
  );

  $form['specialty'] = array(
    '#type' => 'select',
    '#title' => t('Specialty'),
    '#options' => drupal_map_assoc(array(
      'Environmental Experience',
      'Organic Chemistry Techniques',
      'Clinical Specialty',
      'Medical Device Experience',
      'Clinical Technique',
      'Quality',
      'Animal Experience',
      'Biochemistry Techniques',
      'Microbiology Techniques',
      'Clinical Experience',
      'Food and Fragrance Experience',
      'Physical Testing Techniques',
      'Regulatory Affairs',
      'Material Science Experience',
      'Computer Skills',
      'Molecular Biology Techniques',
      'General Chemistry Techniques',
      'Clinical Instrumentation',
      'Instrumentation',
      'Manufacturing Experience',
      'Histology Experience',
      'Formulations',
    )),
    '#required' => TRUE,
  );

  $form['type_of_assignment'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Type of assignment: (check all that apply)'),
    '#options' => drupal_map_assoc(array(
      'Contract',
      'Contract-to-hire',
      'Direct Hire',
    )),
    '#required' => TRUE,
  );

  $form['referral'] = array(
    '#type' => 'select',
    '#title' => t('Were you referred?'),
    '#options' => drupal_map_assoc(array('option 1', 'option 2')),
    '#required' => TRUE,
  );

  $form['resume_file'] = array(
    '#type' => 'file',
    '#title' => t('Paste your resume in text box below:'),
  );

  $form['terms'] = array(
    '#markup' => '<p>Lab Support, a division of On Assignment* ("Company") is an Equal Opportunity Employer. All applicants are considered for employment regardless of age, race, gender, religion, national origin, disability, marital status or any other factor prohibited by law.</p>'. 
      '<p>I certify that the information provided on this Application is accurate. I understand that the withholding of information or the giving of false information on this Application may result in a refusal to hire or disciplinary action including, but not limited to, termination. I understand and agree that if I am offered employment by the company, it will be on an at-will basis. This means that either the Company or I may terminate the employment relationship at any time, for any reason, with or without cause or notice. I also understand and agree that only an officer of the Company can enter into an agreement on any other terms and he/she can only do so in writing signed by the officer and me. I have read the above before signing this Application.</p>'.
      '<p>I further understand and waive my right of privacy in this investigation and release and hold harmless On Assignment from any liability.</p>'.
      '<p>I agree that any decision to hire me is contingent upon the results of my report, and certify that all statements and answers on my Application, resume, or interview are true and complete to the best of my knowledge. I understand that if any statements are false or that if information has been omitted, this will be cause for disqualification and immediate termination of my employment. I further authorize On Assignment to check my conviction record as needed, on a continuous basis as it relates to my employment.</p>'.
      '<p>I authorize On Assignment to release any employment records, including health records submitted to On Assignment to any customer of On Assignment for consideration of employment at customer facility.</p>',
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );

  return $form;
}

/**
 * Form validation callback for onboarding form
 */
function oa_onboard_form_validate($form, &$form_state) {
  // Dupe check email address

}

/**
 * Form submission callback for onboarding form
 */
function oa_onboard_form_submit($form, &$form_state) {
  // Candidates method: FirstName, LastName, Email, AvailableDate (datetime) 
  // PostalAddress method: EntityID, AddressLine1, AddressLine2, Municipality, RegionID (from Region table), PostalCode
  // CandidatePhones method: CandidateID, TypeID (1=Work, 2=Home, 3=Mobile, 72=Other), Phone (strip non-numeric characters)
  
  
  // Resume file upload
  if (isset($_FILES['files']) && is_uploaded_file($_FILES['files']['tmp_name']['resume_file'])) {
    $filepath = $_FILES['files']['tmp_name']['resume_file'];
    $filesize = $_FILES['files']['size']['resume_file'];
    $filename = $_FILES['files']['name']['resume_file'];
    $handle = fopen($filepath, "r");
    $contents = fread($handle, $filesize);
    fclose($handle);

    $params = array(
      // 'dDocName' => ($form_state['values']['lc']['lc_licensure'] == 61) ? '' : $account->rmaxid .'_'. $form_state['values']['lc']['lc_licensure'],
      'dDocTitle' => '9999999 - '. $rmaxid,
      'dDocType' => 'Rmax',
      'dDocAuthor' => 'weblogic',
      'dSecurityGroup' => 'Form',
      'dDocAccount' => 'Recruit/QA',
      'xContentType' => 'Form',
      'xFormType' => 999999999,
      'xRM_ID' => $rmaxid,
      'xStatus' => 'Pending Review',
      'xComments' => '',
      'xRejectReason' => '',
      'xRejectOther' => '',
      'xSuccessAudit' => '',
    );
    $params['primaryFile'] = array(
      'fileName'=> $_FILES['files']['name']['resume_file'],
      'fileContent' => $contents,
    );
    $result = oa_portal_soap('oacheckin', $params);
    if ($result->oacheckinResult->StatusInfo->statusCode === 0) {
      drupal_set_message(t('Your file upload was successful.'));
    }
    else {
      drupal_set_message(t('An error occured. Please try again.'));
    }
  }
  
}

/**
 * Dupe Check menu callback.
 */
function oa_onboard_dupecheck() {
  $Email = $_POST['email'];
  // @TODO RMax dupe check
  // http://rmdev-630.rmaxut.oaifield.onasgn.com/com/recruitmax/webservices/candidateLS/candidateGatewayUS.cfc?wsdl
  // array('Email' => $Email)
  
  watchdog('oaonboard', 'Dupe checked email: '. $Email .'. Duplicate? Y/N');
  // $result-> === 0 means no dupe
  drupal_json(array('status' => (TRUE) ? 'no-dupe' : 'dupe'));
  exit();
}
